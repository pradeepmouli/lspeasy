# Implementation Plan: LSP Protocol Compliance Gaps

**Branch**: `003-lsp-protocol-compliance` | **Date**: 2026-02-12 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/003-lsp-protocol-compliance/spec.md`

**Note**: This plan is generated by `/speckit.plan` workflow.

## Summary

Implement protocol-compliance enhancements across the SDK: dynamic capability registration/unregistration (strict-by-default with opt-in compatibility mode), broaden transport support with TCP + Dedicated Worker + Shared Worker + Node IPC alignment, add partial result streaming ergonomics (ordered accumulation + structured cancel result), and expose notebook sync convenience APIs. Work is delivered as incremental, test-first changes across core/client/server packages with no protocol-breaking behavior.

## Technical Context

**Language/Version**: TypeScript 5.x (strict), ESM, Node.js >= 20 for Node-side runtime; modern browsers for worker transports
**Primary Dependencies**: `vscode-languageserver-protocol`, Node built-ins (`net`, `child_process`, `worker_threads` where applicable), existing internal transport/middleware utilities
**Storage**: N/A (in-memory protocol/session state only)
**Testing**: Vitest (`unit`, `integration`, `e2e`) + protocol-oriented transport tests
**Target Platform**: Node.js (TCP/IPC/stdin/stdout/websocket) + Browser (Dedicated Worker / Shared Worker / websocket)
**Project Type**: pnpm monorepo TypeScript SDK (`packages/core`, `packages/client`, `packages/server`, optional middleware packages)
**Performance Goals**: Preserve non-blocking behavior; no regression in message dispatch throughput; ordered partial-result delivery with low overhead
**Constraints**: Strict LSP compliance, no `any` in public APIs, backward compatibility for existing APIs, worker and TCP edge-case safety, async-first design
**Scale/Scope**: Multi-package feature touching core transport layer, client capability/runtime registry, server helpers, and typed convenience APIs

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Pre-Phase 0 Gate

1. **LSP Protocol Compliance (NON-NEGOTIABLE)** — ✅ PASS
  - All planned behavior maps to standard JSON-RPC/LSP semantics.
  - Explicitly defined errors (`-32602`) and request/response correlation retained.

2. **Type Safety First** — ✅ PASS
  - Public API expansions are typed (dynamic registration store, worker transport interfaces, partial result structured return type).
  - No `any` required in public surfaces.

3. **Modular Package Architecture** — ✅ PASS
  - Transport additions remain in transport-focused modules; client/server ergonomics stay in their packages.
  - No planned circular dependency changes.

4. **Test-First Development** — ✅ PASS
  - Each user story has independent test criteria and acceptance scenarios.
  - Plan mandates unit/integration/e2e additions before implementation completion.

5. **Performance and Async-First Design** — ✅ PASS
  - Async transport and callback/streaming model preserved.
  - Partial-results and worker routing are event-driven, non-blocking.

**Gate Decision (Pre-Phase 0): APPROVED**

## Project Structure

### Documentation (this feature)

```text
specs/003-lsp-protocol-compliance/
├── plan.md
├── research.md
├── data-model.md
├── quickstart.md
├── contracts/
│   ├── dynamic-registration.ts
│   ├── transports.ts
│   ├── partial-results.ts
│   └── notebook-sync.ts
└── tasks.md
```

### Source Code (repository root)

```text
packages/
├── core/
│   ├── src/
│   │   ├── transport/
│   │   │   ├── tcp.ts
│   │   │   ├── ipc.ts
│   │   │   ├── dedicated-worker.ts
│   │   │   ├── shared-worker.ts
│   │   │   └── transport.ts
│   │   └── protocol/
│   └── test/
│       └── unit/
├── client/
│   ├── src/
│   │   ├── client.ts
│   │   ├── capability-proxy.ts
│   │   ├── connection/
│   │   └── transports/
│   └── test/
│       └── unit/
├── server/
│   ├── src/
│   │   ├── server.ts
│   │   └── notebook/
│   └── test/
│       └── unit/
└── middleware/

e2e/
├── transport-*.spec.ts
├── partial-results.spec.ts
└── notebook-sync.spec.ts
```

**Structure Decision**: Continue monorepo package layout; add transport implementations and registration logic in existing package boundaries to preserve modularity and avoid cross-package coupling.

## Phase 0: Research Output

See [research.md](./research.md) for implementation decisions resolving all technical unknowns and tradeoffs.

## Phase 1: Design Output

- Data model: [data-model.md](./data-model.md)
- API contracts: [contracts/](./contracts)
- Usage and validation flows: [quickstart.md](./quickstart.md)

## Post-Design Constitution Re-Check

1. **LSP Protocol Compliance** — ✅ PASS
2. **Type Safety First** — ✅ PASS
3. **Modular Package Architecture** — ✅ PASS
4. **Test-First Development** — ✅ PASS
5. **Performance and Async-First Design** — ✅ PASS

**Gate Decision (Post-Design): APPROVED**

## Complexity Tracking

No constitution violations requiring exception tracking.
